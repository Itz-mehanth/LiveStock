<div class="dashboard-container min-h-screen bg-slate-50 p-4 sm:p-8 font-sans text-slate-800">
  <div class="relative z-10 max-w-7xl mx-auto">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex items-center justify-center min-h-[80vh]">
      <div class="text-center p-8">
        <mat-spinner diameter="60" class="!stroke-indigo-600 mx-auto"></mat-spinner>
        <p class="mt-6 text-lg font-medium text-slate-600">Loading Market Data...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="flex items-center justify-center min-h-[80vh]">
      <div class="text-center p-8 bg-white rounded-2xl shadow-xl max-w-sm border border-red-200">
        <mat-icon class="!text-red-500 !text-6xl !w-16 !h-16 mx-auto mb-4">error_outline</mat-icon>
        <h3 class="text-2xl font-semibold text-slate-800 mb-2">Connection Error</h3>
        <p class="text-slate-500 mb-6">{{ error }}</p>
        <button mat-raised-button color="primary" (click)="fetchData()" class="!bg-indigo-600 hover:!bg-indigo-700 !text-white !font-semibold !py-2 !px-4 !rounded-lg flex items-center justify-center gap-2 mx-auto">
          <mat-icon>refresh</mat-icon>
          Retry
        </button>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div *ngIf="!isLoading && !error" class="space-y-6">
      <!-- Header Section -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <!-- Company Selector -->
        <div class="bg-white border border-slate-200/80 rounded-2xl shadow-md p-6">
          <div class="flex items-center gap-3 mb-4">
            <mat-icon class="!text-indigo-600">business</mat-icon>
            <h3 class="text-xl font-semibold text-slate-800">Select Company</h3>
          </div>
          <mat-form-field appearance="fill" class="w-full company-dropdown">
            <mat-label class="!text-slate-500">Company / Symbol</mat-label>
            <mat-select [(value)]="selectedCompany" (selectionChange)="filterDataByCompany($event.value)" panelClass="custom-mat-select-panel">
              <mat-option value="ALL" class="!text-indigo-600 !font-semibold">All Companies (Comparison)</mat-option>
              <mat-option *ngFor="let company of companies" [value]="company.symbol">
                <div class="flex items-center justify-between w-full">
                  <span class="font-bold text-slate-800">{{ company.symbol }}</span>
                  <span class="text-slate-500">${{ company.currentPrice | number:'1.2-2' }}</span>
                  <span class="text-xs font-semibold px-2 py-1 rounded-md" [ngClass]="{
                    'bg-green-100 text-green-800': company.change > 0,
                    'bg-red-100 text-red-800': company.change < 0,
                    'bg-slate-100 text-slate-600': company.change === 0
                  }">
                    {{ company.change > 0 ? '+' : '' }}{{ company.changePercent | number:'1.2-2' }}%
                  </span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Prediction Panel -->
        <div *ngIf="selectedCompany !== 'ALL'" class="bg-white border border-slate-200/80 rounded-2xl shadow-md p-6">
          <div class="flex items-center gap-3 mb-4">
            <mat-icon class="!text-purple-600">online_prediction</mat-icon>
            <h3 class="text-xl font-semibold text-slate-800">Predict Future Prices</h3>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <mat-form-field appearance="fill" class="w-full sm:w-2/3 prediction-dropdown">
              <mat-label class="!text-slate-500">Time Horizon</mat-label>
              <mat-select [(value)]="selectedHorizon" panelClass="custom-mat-select-panel">
                <mat-option *ngFor="let option of horizonOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <button mat-raised-button (click)="fetchPredictions()" [disabled]="isPredicting" class="w-full sm:w-1/3 !bg-purple-600 hover:!bg-purple-700 disabled:!bg-purple-600/50 !text-white !font-semibold !py-3 !px-4 !rounded-lg flex items-center justify-center gap-2">
              <mat-spinner *ngIf="isPredicting" diameter="20" class="!stroke-white"></mat-spinner>
              <span *ngIf="!isPredicting">Predict</span>
            </button>
          </div>
          <div *ngIf="predictions.length > 0" class="mt-4 pt-4 border-t border-slate-200">
            <h4 class="font-semibold text-slate-700 mb-2">Predictions for {{ selectedCompany }}</h4>
            <ul class="space-y-2 text-sm">
              <li *ngFor="let p of predictions" class="flex justify-between items-center bg-slate-100 p-2 rounded-md">
                <span class="text-slate-600">{{ p.timestamp | date:'short' }}</span>
                <span class="font-bold text-purple-700">${{ p.predicted_price | number:'1.2-2' }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Header Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="stat-card bg-white border border-slate-200/80 rounded-2xl shadow-md p-6">
          <div class="flex items-center text-slate-500 mb-3">
            <mat-icon class="!text-indigo-600">show_chart</mat-icon>
            <span class="ml-2 text-sm font-bold uppercase tracking-wider">{{ selectedCompany === 'ALL' ? 'Market Overview' : selectedCompany + ' Price' }}</span>
          </div>
          <div class="text-4xl font-bold text-slate-800 mb-2">
            <ng-container *ngIf="selectedCompany !== 'ALL'">${{ currentPrice | number:'1.2-2' }}</ng-container>
            <ng-container *ngIf="selectedCompany === 'ALL'">{{ companies.length }} Stocks</ng-container>
          </div>
          <div *ngIf="selectedCompany !== 'ALL'" class="flex items-center text-sm font-semibold" [ngClass]="{'text-green-600': isPriceUp, 'text-red-600': isPriceDown, 'text-slate-500': priceChange === 0}">
            <mat-icon>{{ isPriceUp ? 'trending_up' : isPriceDown ? 'trending_down' : 'trending_flat' }}</mat-icon>
            <span>{{ priceChange > 0 ? '+' : '' }}${{ priceChange | number:'1.2-2' }} ({{ priceChange > 0 ? '+' : '' }}{{ priceChangePercent | number:'1.2-2' }}%)</span>
          </div>
        </div>
        <div class="stat-card bg-white border border-slate-200/80 rounded-2xl shadow-md p-6">
          <div class="flex items-center text-slate-500 mb-3">
            <mat-icon class="!text-indigo-600">analytics</mat-icon>
            <span class="ml-2 text-sm font-bold uppercase tracking-wider">Data Points</span>
          </div>
          <div class="text-4xl font-bold text-slate-800 mb-2">{{ totalDataPoints }}</div>
          <div class="text-sm text-slate-500">Active Measurements</div>
        </div>
        <div class="stat-card bg-white border border-slate-200/80 rounded-2xl shadow-md p-6">
          <div class="flex items-center text-slate-500 mb-3">
            <mat-icon class="!text-indigo-600">update</mat-icon>
            <span class="ml-2 text-sm font-bold uppercase tracking-wider">Last Update</span>
          </div>
          <div class="text-4xl font-bold text-slate-800 mb-2">{{ lastUpdate | date:'mediumTime' }}</div>
          <div class="text-sm text-slate-500">Auto-refreshes every 5s</div>
        </div>
      </div>

      <!-- Chart Card -->
      <div class="bg-white border border-slate-200/80 rounded-2xl shadow-lg p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start mb-6">
          <div>
            <h2 class="text-2xl font-bold text-slate-800">{{ selectedCompany === 'ALL' ? 'Market Comparison' : selectedCompany + ' Performance' }}</h2>
            <p class="text-slate-500">Real-time average price tracking</p>
          </div>
          <button mat-icon-button matTooltip="Reset Zoom" (click)="resetZoom()" class="!bg-slate-100 hover:!bg-slate-200 !text-slate-600 mt-4 sm:mt-0">
            <mat-icon>zoom_out_map</mat-icon>
          </button>
        </div>
        <div class="h-[500px] relative">
          <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" type="line"></canvas>
        </div>
        <div class="text-center mt-4 text-slate-400 text-sm flex items-center justify-center gap-2">
          <mat-icon>touch_app</mat-icon>
          <span>Scroll to zoom â€¢ Drag to pan</span>
        </div>
      </div>
    </div>
  </div>
</div>

