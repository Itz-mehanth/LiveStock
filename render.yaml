# This blueprint deploys your entire backend application stack on Render.
# It uses the corrected format for database users and Docker runtimes.

databases:
  # 1. Managed PostgreSQL Database
  - name: postgres
    databaseName: stock_db
    # FIX: Changed the user from 'postgres' to a custom name
    user: stock_user
    plan: free

services:
  # 2. Zookeeper Service (Private)
  - type: worker
    name: zookeeper
    # FIX: Explicitly set the runtime to 'docker'
    runtime: docker
    plan: free
    image:
      url: confluentinc/cp-zookeeper:7.5.0
    envVars:
      - key: ZOOKEEPER_CLIENT_PORT
        value: 2181
      - key: ZOOKEEPER_TICK_TIME
        value: 2000

  # 3. Kafka Service (Private)
  - type: worker
    name: kafka
    # FIX: Explicitly set the runtime to 'docker'
    runtime: docker
    plan: free
    image:
      url: confluentinc/cp-kafka:7.5.0
    envVars:
      - key: KAFKA_BROKER_ID
        value: 1
      - key: KAFKA_ZOOKEEPER_CONNECT
        value: zookeeper:2181
      - key: KAFKA_ADVERTISED_LISTENERS
        value: PLAINTEXT://kafka:29092
      - key: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
        value: 1
      - key: KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS
        value: 0

  # 4. Data Producer Service (Private)
  - type: worker
    name: producer
    # FIX: Explicitly set the runtime to 'docker'
    runtime: docker
    plan: free
    dockerfilePath: ./producer/Dockerfile
    dockerContext: ./producer
    envVars:
      - key: KAFKA_BROKER
        value: kafka:29092

  # 5. Spark Processing Service (Private)
  - type: worker
    name: spark
    # FIX: Explicitly set the runtime to 'docker'
    runtime: docker
    plan: free
    dockerfilePath: ./spark/Dockerfile
    dockerContext: ./spark
    envVars:
      - key: KAFKA_BROKER
        value: kafka:29092
      - key: POSTGRES_HOST
        fromDatabase:
          name: postgres
          property: host
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: postgres
          property: password
      # FIX: Added the new database user
      - key: POSTGRES_USER
        fromDatabase:
          name: postgres
          property: user

  # 6. Backend API Service (Publicly Accessible)
  - type: web
    name: backend
    # FIX: Explicitly set the runtime to 'docker'
    runtime: docker
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /api/stock_data
    envVars:
      - key: POSTGRES_HOST
        fromDatabase:
          name: postgres
          property: host
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: postgres
          property: password
      # FIX: Added the new database user
      - key: POSTGRES_USER
        fromDatabase:
          name: postgres
          property: user

